<meta name='viewport' content='width=device-width, initial-scale=1'/><!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>5/3/1 Planner -- Weekly Cycles with Auto TM</title>
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; }
  body { margin: 24px; max-width: 1000px; }
  header { display:flex; gap:12px; justify-content:space-between; align-items:center; flex-wrap:wrap; }
  h1 { font-size: 1.25rem; margin: 0; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap: 16px; margin: 16px 0; }
  .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; background:#fff; }
  .grid { display:grid; gap: 10px; }
  label { font-size:.9rem; }
  input, select, button, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid #ccc; }
  input[type="checkbox"]{ width:auto; }
  .muted { color:#666; font-size:.9rem; }
  table { width:100%; border-collapse: collapse; margin-top: 10px; }
  th, td { padding: 8px; border-bottom: 1px solid #eee; text-align:left; vertical-align: top; }
  .actions { display:flex; gap:8px; flex-wrap:wrap; }
  .pill { padding:6px 10px; border-radius:999px; background:#f5f5f5; font-size:.85rem; }
  .ok { color:#0a7; }
  .warn { color:#a70; }
  .danger { color:#c00; }
  .liftBox { border:1px solid #eee; border-radius:10px; padding:10px; }
  .flex { display:flex; gap:10px; flex-wrap:wrap; }
  .half { flex:1 1 180px; }
  footer { margin-top: 24px; color:#666; font-size:.9rem; }
  details summary { cursor: pointer; margin: 8px 0; }
  .small { font-size: .85rem; }
</style>
</head>
<body>
<header>
  <h1>5/3/1 Planner -- Cycles with Auto TM</h1>
  <div class="actions">
    <button id="exportBtn">Export</button>
    <button id="importBtn">Import</button>
    <button id="resetBtn" class="danger">Reset</button>
  </div>
</header>

<div class="row">
  <section class="card">
    <h2>Global Settings</h2>
    <div class="grid">
      <div class="flex">
        <div class="half">
          <label>Units</label>
          <select id="unit">
            <option value="kg">kg</option>
            <option value="lb">lb</option>
          </select>
        </div>
        <div class="half">
          <label>Round to nearest</label>
          <select id="roundTo">
            <option value="2.5">2.5</option>
            <option value="1">1</option>
            <option value="0.5">0.5</option>
          </select>
        </div>
      </div>
      <div class="flex">
        <div class="half">
          <label>Use Training Max (TM = 90% of 1RM)?</label>
          <select id="useTM">
            <option value="yes">Yes (90%)</option>
            <option value="no">No (use 1RM directly)</option>
          </select>
        </div>
        <div class="half">
          <label>Bar weight (for plate math)</label>
          <input id="barWeight" type="number" step="0.5" value="20" />
        </div>
      </div>
      <div>
        <label>Available plates per side (comma-separated, largest→smallest)</label>
        <input id="plates" placeholder="25,20,15,10,5,2.5,1.25,0.5" value="25,20,15,10,5,2.5,1.25" />
      </div>
      <div class="muted small">
        Weeks: W1 65/75/85 ×5+, W2 70/80/90 ×3+, W3 75/85/95 ×5/3/1+, W4 40/50/60 ×5 (Deload). After W4, TM auto-bumps and cycle increments.
      </div>
    </div>
  </section>

  <section class="card">
    <h2>Add / Edit Lift</h2>
    <div class="grid">
      <div class="flex">
        <div class="half">
          <label>Lift name</label>
          <input id="liftName" placeholder="e.g., Squat" />
        </div>
        <div class="half">
          <label>1RM (estimated or tested)</label>
          <input id="lift1RM" type="number" step="0.5" />
        </div>
      </div>
      <div class="flex">
        <div class="half">
          <label>TM add per cycle (default Upper +2.5)</label>
          <input id="liftInc" type="number" step="0.5" placeholder="e.g., 2.5 or 5" />
        </div>
        <div class="half">
          <label>Notes</label>
          <input id="liftNotes" placeholder="e.g., belt on W2+" />
        </div>
      </div>
      <div class="actions">
        <button id="saveLift">Save Lift</button>
      </div>
      <p class="muted small">Tip: leave "TM add per cycle" blank to smart-default (+2.5 press/bench, +5 squat/deadlift).</p>
    </div>
  </section>
</div>

<section class="card">
  <h2>Cycle & Week</h2>
  <div class="flex">
    <div class="half">
      <label>Current cycle</label>
      <input id="cycleNum" type="number" min="1" value="1" />
    </div>
    <div class="half">
      <label>Week</label>
      <select id="weekSel">
        <option value="1">Week 1 (5+)</option>
        <option value="2">Week 2 (3+)</option>
        <option value="3">Week 3 (5/3/1+)</option>
        <option value="4">Week 4 (Deload)</option>
      </select>
    </div>
  </div>
  <div class="actions" style="margin-top:10px;">
    <button id="prevWeek">◀ Prev</button>
    <button id="nextWeek">Next ▶</button>
    <button id="autoAdvance">Auto-advance on complete</button>
  </div>
  <p class="muted small">"Auto-advance" bumps to the next week once all main sets are marked complete. After Week 4 it increments the cycle and applies TM increases.</p>
</section>

<section class="card">
  <h2>Lifts</h2>
  <div id="liftsContainer"><!-- lift cards injected --></div>
</section>

<section class="card">
  <h2>Plate Math (per set)</h2>
  <details open>
    <summary>How it works</summary>
    <p class="muted small">
      Enter your bar weight and available plates. For each working set weight, the app shows plate loading per side (greedy fit).
      You can ignore this if you don't need it.
    </p>
  </details>
</section>

<footer>
  <span class="pill">5/3/1</span>
  <span class="pill">TM cycles</span>
  <span class="pill">Local only</span>
</footer>

<input type="file" id="fileInput" accept="application/json" hidden />

<script>
(() => {
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const storeKey = "fiveThreeOnePlannerV1";

  const defaultState = {
    settings: {
      unit: "kg",
      roundTo: 2.5,
      useTM: "yes",   // yes => TM = 90% 1RM; no => use 1RM directly
      barWeight: 20,
      plates: "25,20,15,10,5,2.5,1.25"
    },
    program: {
      cycle: 1,
      week: 1,
      lifts: [
        // sample starters (edit or delete)
        // { id, name, oneRM, notes, perCycleInc, history: [{cycle, week, mainDone}], amrap: [{cycle,week,text}] }
      ]
    },
    // per-lift persistent TM cache (because 1RM might change over time)
    tmCache: {
      // liftId: { base1RM, useTM, tmByCycle: { [cycle]: TMNumber } }
    }
  };

  let state = load() || defaultState;

  // DOM refs
  const unitEl = $("#unit"), roundToEl = $("#roundTo"), useTMEl = $("#useTM");
  const barWeightEl = $("#barWeight"), platesEl = $("#plates");
  const liftNameEl = $("#liftName"), lift1RMEl = $("#lift1RM"), liftIncEl = $("#liftInc"), liftNotesEl = $("#liftNotes");
  const saveLiftBtn = $("#saveLift");
  const cycleNumEl = $("#cycleNum"), weekSelEl = $("#weekSel");
  const prevWeekBtn = $("#prevWeek"), nextWeekBtn = $("#nextWeek"), autoAdvanceBtn = $("#autoAdvance");
  const liftsContainer = $("#liftsContainer");
  const exportBtn = $("#exportBtn"), importBtn = $("#importBtn"), resetBtn = $("#resetBtn"), fileInput = $("#fileInput");

  function save(){ localStorage.setItem(storeKey, JSON.stringify(state)); }
  function load(){ try { return JSON.parse(localStorage.getItem(storeKey)); } catch { return null; } }

  // utils
  const escapeHTML = s => (s||"").replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const roundTo = (x, step) => Math.round(x/step)*step;
  const idGen = () => (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random()));

  // 5/3/1 scheme
  // W1: 65/75/85 (5+), W2: 70/80/90 (3+), W3: 75/85/95 (5/3/1+), W4: 40/50/60 (deload 5s)
  const WEEK_SCHEMES = {
    1: [{pct:0.65,reps:"5+"},{pct:0.75,reps:"5+"},{pct:0.85,reps:"5+"}],
    2: [{pct:0.70,reps:"3+"},{pct:0.80,reps:"3+"},{pct:0.90,reps:"3+"}],
    3: [{pct:0.75,reps:"5"},{pct:0.85,reps:"3"},{pct:0.95,reps:"1+"}],
    4: [{pct:0.40,reps:"5"},{pct:0.50,reps:"5"},{pct:0.60,reps:"5"}]
  };

  function isUpper(name){
    const n = (name||"").toLowerCase();
    return n.includes("press") || n.includes("bench") || n.includes("ohp") || n.includes("shoulder");
  }
  function smartIncForLift(name){
    // default increments per cycle (TM bump after week 4)
    return isUpper(name) ? 2.5 : 5;
  }

  function parsePlates(){
    const p = (state.settings.plates||"").split(",").map(s=>Number(s.trim())).filter(x=>isFinite(x)&&x>0);
    return p.sort((a,b)=>b-a); // largest→smallest
  }

  function tmFor(liftId, cycle){
    const lift = state.program.lifts.find(l=>l.id===liftId);
    if (!lift) return null;
    const cache = state.tmCache[liftId] || (state.tmCache[liftId] = { base1RM: lift.oneRM, useTM: state.settings.useTM, tmByCycle:{} });

    // If 1RM or TM preference changed since last calc, reset cache
    if (cache.base1RM !== lift.oneRM || cache.useTM !== state.settings.useTM) {
      cache.base1RM = lift.oneRM;
      cache.useTM = state.settings.useTM;
      cache.tmByCycle = {};
    }

    if (cache.tmByCycle[cycle]) return cache.tmByCycle[cycle];

    // derive TM for cycle 1
    const base = state.settings.useTM==="yes" ? 0.9*lift.oneRM : lift.oneRM;
    const step = Number(state.settings.roundTo) || 2.5;

    // compute prior cycles if needed
    let tm = roundTo(base, step);
    for (let c=1; c<=cycle; c++){
      if (c===1) {
        cache.tmByCycle[c] = tm;
      } else {
        // apply per-cycle increment based on lift settings
        const inc = (lift.perCycleInc!=null && lift.perCycleInc!=="" ? Number(lift.perCycleInc) : smartIncForLift(lift.name));
        tm = roundTo(tm + inc, step);
        cache.tmByCycle[c] = tm;
      }
    }
    return cache.tmByCycle[cycle];
  }

  function workingSets(lift){
    const cycle = Number(state.program.cycle)||1;
    const week = Number(state.program.week)||1;
    const tm = tmFor(lift.id, cycle);
    const scheme = WEEK_SCHEMES[week] || [];
    const step = Number(state.settings.roundTo)||2.5;

    return scheme.map(s=>{
      const raw = tm * s.pct;
      const w = roundTo(raw, step);
      return { pct: s.pct, reps: s.reps, raw: raw, weight: Number(w.toFixed(3)) };
    });
  }

  function plateMath(target){
    const bar = Number(state.settings.barWeight)||20;
    const plates = parsePlates();
    const perSide = (target - bar)/2;
    if (perSide <= 0) return { ok:false, perSideWeight:0, stack:[] };

    let remaining = perSide;
    const stack=[];
    for (const p of plates){
      while (remaining >= p - 1e-9){ // tiny epsilon
        stack.push(p);
        remaining = +(remaining - p).toFixed(5);
      }
    }
    const ok = Math.abs(remaining) < 1e-6;
    return { ok, perSideWeight: perSide, stack, leftover: remaining };
  }

  function render(){
    // settings
    unitEl.value = state.settings.unit;
    roundToEl.value = String(state.settings.roundTo);
    useTMEl.value = state.settings.useTM;
    barWeightEl.value = state.settings.barWeight;
    platesEl.value = state.settings.plates;

    // cycle/week
    cycleNumEl.value = state.program.cycle;
    weekSelEl.value = String(state.program.week);

    // lifts
    liftsContainer.innerHTML = "";
    state.program.lifts.forEach(lift=>{
      const sets = workingSets(lift);
      const card = document.createElement("div");
      card.className = "liftBox";

      // completion status for main sets this week
      const key = `${state.program.cycle}-${state.program.week}`;
      const done = (lift.history||[]).some(h=>h.cycle===state.program.cycle && h.week===state.program.week && h.mainDone);
      const amrapNote = (lift.amrap||[]).find(x=>x.cycle===state.program.cycle && x.week===state.program.week)?.text || "";

      const tmVal = tmFor(lift.id, state.program.cycle);

      card.innerHTML = `
        <div class="flex" style="align-items:center; justify-content:space-between;">
          <div>
            <strong>${escapeHTML(lift.name)}</strong>
            <div class="muted small">${escapeHTML(lift.notes||"")}</div>
          </div>
          <div class="pill ${done?'ok':'warn'}">${done?'Completed':'Not completed'}</div>
        </div>
        <div class="small muted" style="margin-top:6px;">
          1RM: ${lift.oneRM} ${state.settings.unit} • TM (cycle ${state.program.cycle}): <strong>${tmVal?.toFixed(2) || "--"}</strong> ${state.settings.unit} • Per-cycle inc: ${lift.perCycleInc!=null&&lift.perCycleInc!==""?lift.perCycleInc:smartIncForLift(lift.name)} ${state.settings.unit}
        </div>

        <table>
          <thead><tr><th>Set</th><th>% of TM</th><th>Target</th><th>Weight</th><th>Plates/side</th></tr></thead>
          <tbody>
            ${sets.map((s, i)=>{
              const pm = plateMath(s.weight);
              const stack = pm.stack.map(x=>`${x}`).join(", ");
              const pmTxt = pm.ok ? stack || "--" : `~ ${stack}${pm.stack.length?"; ":""}leftover`;
              return `
                <tr>
                  <td>${i+1}</td>
                  <td>${(s.pct*100).toFixed(0)}%</td>
                  <td>${escapeHTML(s.reps)}</td>
                  <td><strong>${s.weight}</strong> ${state.settings.unit}</td>
                  <td class="small">${pmTxt}</td>
                </tr>
              `;
            }).join("")}
          </tbody>
        </table>

        <div class="grid" style="margin-top:8px;">
          <div>
            <label class="small">AMRAP / Notes (this week)</label>
            <textarea data-act="amrap" data-id="${lift.id}" rows="2" placeholder="e.g., W1 last set 9 reps, RPE 9">${escapeHTML(amrapNote)}</textarea>
          </div>
          <div class="actions">
            <button data-act="markDone" data-id="${lift.id}">${done?'Unmark Complete':'Mark Main Sets Complete'}</button>
            <button data-act="edit" data-id="${lift.id}">Edit Lift</button>
            <button data-act="delete" data-id="${lift.id}" class="danger">Delete Lift</button>
          </div>
        </div>
      `;
      liftsContainer.appendChild(card);
    });
  }

  // apply state changes
  function setSetting(k, v){
    state.settings[k] = v;
    if (k==="useTM") {
      // reset TM cache if TM mode toggled
      state.tmCache = {};
    }
    save(); render();
  }

  // event wiring
  unitEl.addEventListener("change", ()=> setSetting("unit", unitEl.value));
  roundToEl.addEventListener("change", ()=> { setSetting("roundTo", Number(roundToEl.value)); state.tmCache={}; });
  useTMEl.addEventListener("change", ()=> setSetting("useTM", useTMEl.value));
  barWeightEl.addEventListener("change", ()=> setSetting("barWeight", Number(barWeightEl.value)));
  platesEl.addEventListener("change", ()=> setSetting("plates", platesEl.value));

  saveLiftBtn.addEventListener("click", ()=>{
    const name = liftNameEl.value.trim();
    const oneRM = Number(lift1RMEl.value);
    if (!name || !isFinite(oneRM)) { alert("Enter a lift name and a valid 1RM."); return; }
    const perCycleInc = liftIncEl.value==="" ? null : Number(liftIncEl.value);
    const notes = liftNotesEl.value.trim();
    const id = idGen();
    state.program.lifts.push({ id, name, oneRM, notes, perCycleInc, history:[], amrap:[] });
    // clear
    liftNameEl.value=""; lift1RMEl.value=""; liftIncEl.value=""; liftNotesEl.value="";
    state.tmCache[id] = undefined;
    save(); render();
  });

  liftsContainer.addEventListener("click", (e)=>{
    const btn = e.target.closest("button");
    if (!btn) return;
    const id = btn.dataset.id;
    const act = btn.dataset.act;
    const lift = state.program.lifts.find(l=>l.id===id);
    if (!lift) return;

    if (act==="delete"){
      if (!confirm("Delete this lift?")) return;
      state.program.lifts = state.program.lifts.filter(l=>l.id!==id);
      delete state.tmCache[id];
      save(); render();
    }
    if (act==="edit"){
      const newName = prompt("Lift name:", lift.name); if (newName===null) return;
      const new1RM = Number(prompt("1RM:", lift.oneRM)); if (!isFinite(new1RM)) return;
      const newInc = prompt("Per-cycle inc (blank = smart default):", lift.perCycleInc??"");
      const newNotes = prompt("Notes:", lift.notes||"");
      lift.name = newName.trim() || lift.name;
      lift.oneRM = new1RM;
      lift.perCycleInc = newInc===""? null : Number(newInc);
      lift.notes = (newNotes||"").trim();
      state.tmCache[lift.id] = undefined;
      save(); render();
    }
    if (act==="markDone"){
      const exists = (lift.history||[]).find(h=>h.cycle===state.program.cycle && h.week===state.program.week);
      if (exists) {
        exists.mainDone = !exists.mainDone;
      } else {
        (lift.history ||= []).push({ cycle: state.program.cycle, week: state.program.week, mainDone:true });
      }
      save(); render();
    }
  });

  // AMRAP text change (debounced-ish)
  let amrapTimer = null;
  liftsContainer.addEventListener("input", (e)=>{
    const ta = e.target.closest("textarea[data-act='amrap']");
    if (!ta) return;
    const id = ta.dataset.id;
    const lift = state.program.lifts.find(l=>l.id===id);
    if (!lift) return;
    const entry = (lift.amrap||[]).find(x=>x.cycle===state.program.cycle && x.week===state.program.week);
    if (entry) entry.text = ta.value;
    else (lift.amrap ||= []).push({ cycle: state.program.cycle, week: state.program.week, text: ta.value });

    clearTimeout(amrapTimer);
    amrapTimer = setTimeout(()=>{ save(); }, 300);
  });

  // cycle & week controls
  function setWeek(w){ state.program.week = Math.max(1, Math.min(4, Number(w))); save(); render(); }
  function setCycle(c){ state.program.cycle = Math.max(1, Number(c)); save(); render(); }

  cycleNumEl.addEventListener("change", ()=> setCycle(Number(cycleNumEl.value)));
  weekSelEl.addEventListener("change", ()=> setWeek(Number(weekSelEl.value)));
  prevWeekBtn.addEventListener("click", ()=>{
    if (state.program.week>1) setWeek(state.program.week-1);
    else if (state.program.cycle>1) { setCycle(state.program.cycle-1); setWeek(4); }
  });
  nextWeekBtn.addEventListener("click", ()=>{
    if (state.program.week<4) setWeek(state.program.week+1);
    else { setCycle(state.program.cycle+1); setWeek(1); }
  });

  // auto-advance: go to next week when all lifts marked done; if week 4 → bump cycle + TM
  autoAdvanceBtn.addEventListener("click", ()=>{
    const allDone = state.program.lifts.length>0 && state.program.lifts.every(l=>{
      return (l.history||[]).some(h=>h.cycle===state.program.cycle && h.week===state.program.week && h.mainDone);
    });
    if (!allDone) { alert("Not all lifts are marked complete."); return; }

    if (state.program.week < 4){
      setWeek(state.program.week+1);
    } else {
      // week 4 finished → new cycle (TM bumps happen via tmFor calculation using perCycleInc)
      setCycle(state.program.cycle+1);
      setWeek(1);
      alert("Deload complete. New cycle started. TMs have increased based on per-lift increments.");
    }
  });

  // export/import/reset
  exportBtn.addEventListener("click", ()=>{
    const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "531-planner.json";
    a.click();
    URL.revokeObjectURL(a.href);
  });
  importBtn.addEventListener("click", ()=> fileInput.click());
  fileInput.addEventListener("change", async (e)=>{
    const file = e.target.files?.[0]; if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      if (!data.settings || !data.program) throw new Error("Invalid file");
      state = data;
      save(); render();
    } catch (err) {
      alert("Invalid JSON file.");
    }
  });
  resetBtn.addEventListener("click", ()=>{
    if (!confirm("Reset all data?")) return;
    localStorage.removeItem(storeKey);
    state = JSON.parse(JSON.stringify(defaultState));
    save(); render();
  });

  // initial render
  render();
})();
</script>
</body>
</html>